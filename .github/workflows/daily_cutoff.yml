name: Daily Absent Cutoff

on:
  schedule:
    # UTC (ช้ากว่าไทย 7 ชม.)
    # ตั้งเวลาให้รันถี่ขึ้นในช่วงที่น่าจะมีการตัดยอด (16:00 - 24:00 น. ไทย)
    # เนื่องจากสคริปต์มีการตรวจสอบเวลาไทย (UTC+7) อยู่แล้ว การรันถี่จะทำให้มันไม่พลาดเวลา
    
    # รอบเช้า (09:00 น. ไทย)
    - cron: '0 2 * * *' 
    
    # รันทุก 30 นาที ระหว่าง 9:30 - 17:00 UTC (16:30 น. - 24:00 น. ไทย)
    - cron: '30 9-16/1 * * *'  # 9:30, 10:30, 11:30, ..., 16:30 UTC
    - cron: '0 10-17/1 * * *'  # 10:00, 11:00, 12:00, ..., 17:00 UTC
    
  workflow_dispatch: # เพื่อให้กดรันเล่นได้ด้วย

jobs:
  cutoff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        # ติดตั้ง dayjs และ firebase-admin
        run: npm install firebase-admin dayjs

      - name: Run Cutoff Script
        env:
          # ดึง Secret Key เพื่อเชื่อมต่อ Firebase
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: node scripts/auto-cutoff.js